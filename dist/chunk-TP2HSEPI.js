import{useState as d,useEffect as H,useRef as ce}from"react";import{Box as m,Text as e}from"ink";import W from"ink-select-input";import y from"fs";import u from"path";import{createServer as ue}from"vite";import{fileURLToPath as me}from"url";import S from"@process.co/element-dev-support/dist/index.js";import{Fragment as ge,jsx as o,jsxs as r}from"react/jsx-runtime";var Pe=({rootDir:f})=>{let[L,V]=d([]),[T,Q]=d(null),[k,Z]=d([]),[A,ee]=d(null),[B,te]=d([]),[ne,R]=d(null),[K,re]=d(null),[x,c]=d("loading"),[w,G]=d("elements"),[C,X]=d([]),U=ce(X);U.current=X;let[$,oe]=d(null),[pe,ie]=d(null),[se,le]=d(!1),ae=async(a,t,i)=>{try{let l=y.statSync(a).isDirectory()?a:u.dirname(a),s=i==="action"?"actions":"sources",n=u.join(l,s);if(!y.existsSync(n))return null;let g=(await S.importFolderModulesOfType(s,i,l,["common"])).find(p=>p.key===t);if(!g)return null;let P=y.readdirSync(n).filter(p=>{let h=u.join(n,p);return y.statSync(h).isDirectory()}),_=null,j=null;for(let p of P){let h=u.join(n,p),J=[`${p}.mjs`,`${p}.mts`,`${p}.js`,`${p}.ts`,"index.mjs","index.mts","index.js","index.ts"];for(let F of J){let I=u.join(h,F);if(y.existsSync(I))try{let{module:D}=await S.importFromPath(I);if(D.key===t){_=I,j=h;break}}catch{continue}}if(_)break}if(!_)return null;let N=u.join(l,"ui");return g&&g.ui&&(N=u.join(l,"ui",g.ui)),{modulePath:_,uiDir:N}}catch{return null}};H(()=>{(async()=>{try{try{let s=await S.autoDetectElement(f);if(s!=="pipedream"){let n=await S.loadElementPointers(f,s);V([{label:`${n.name} (${n.elementType})`,value:n.name,info:n,path:f}]),c("ready");return}}catch{}let t=y.readdirSync(f,{withFileTypes:!0}),i=[];for(let s of t){let n=u.join(f,s.name);if(s.isDirectory())try{y.readdirSync(n).some(g=>g.endsWith(".mjs")||g.endsWith(".mts")||g.endsWith(".js")||g.endsWith(".ts")||g.endsWith(".tsx")||g.endsWith(".jsx"))&&i.push(n)}catch{}}if(i.length===0){c("no-elements");return}let l=[];for(let s of i)try{let n=await S.loadElementPointers(s,"auto");l.push({label:`${n.name} (${n.elementType})`,value:n.name,info:n,path:s})}catch{}if(l.length>0){V(l),c("ready");return}else c("no-elements")}catch{c("error")}})()},[f]),H(()=>{$&&x==="launching"&&c("dev-server-running")},[$,x]),H(()=>{},[x]);let M=async(a,t,i)=>{if(!a)return;let l=await ae(a.path,t.value,t.type);if(!l){c("error");return}let s=y.statSync(a.path).isDirectory()?a.path:u.dirname(a.path),n=u.join(s,"dev"),O=y.existsSync(n)?n:s,g=me(import.meta.url),P=u.dirname(g),_=u.resolve(P,"../.process/vite.config.cjs"),j=u.join(O,"vite.config.js"),N=u.join(O,"vite.config.ts"),p=_;y.existsSync(j)?p=j:y.existsSync(N)&&(p=N);let h=await S.loadElementPointers(a.path,"auto"),J=h.actions?.find(E=>E.key===t.value)||h.signals?.find(E=>E.key===t.value),F=[u.resolve(process.cwd(),"process-co","ui","src"),u.resolve(P,"..","..","ui","src"),u.resolve(P,"..","ui","src")],I=!1;for(let E of F)if(y.existsSync(E)){I=!0;break}le(I),process.env.VITE_ELEMENT_PATH=a.path,process.env.VITE_ELEMENT_TYPE=t.type,process.env.VITE_ELEMENT_NAME=a.info.name,process.env.VITE_ACTION_SIGNAL_KEY=t.value,process.env.VITE_PROPERTY_KEY=i?.propertyKey||"",process.env.VITE_PROPERTY_TYPE=i?.type||"",process.env.VITE_PROPERTY_UI_PATH=i?.uiPath||"",process.env.VITE_MODULE_PATH=l.modulePath,process.env.VITE_UI_DIRECTORY=l.uiDir,process.env.VITE_HAS_LOCAL_UI_SOURCE=I?"true":"false";let D=1;try{let E=await ue({configFile:p,root:u.resolve(P,"../.process"),optimizeDeps:{include:["react","react-dom"],exclude:[a.path]},define:{"import.meta.env.VITE_ELEMENT_PATH":JSON.stringify(a.path),"import.meta.env.VITE_ELEMENT_TYPE":JSON.stringify(t.type),"import.meta.env.VITE_ELEMENT_NAME":JSON.stringify(a.info.name),"import.meta.env.VITE_ACTION_SIGNAL_KEY":JSON.stringify(t.value),"import.meta.env.VITE_PROPERTY_KEY":JSON.stringify(i?.propertyKey||null),"import.meta.env.VITE_PROPERTY_TYPE":JSON.stringify(i?.type||null),"import.meta.env.VITE_PROPERTY_UI_PATH":JSON.stringify(i?.uiPath||null),"import.meta.env.VITE_MODULE_PATH":JSON.stringify(l.modulePath),"import.meta.env.VITE_UI_DIRECTORY":JSON.stringify(l.uiDir),"import.meta.env.VITE_ELEMENT_MODULE":JSON.stringify(h),"import.meta.env.VITE_CURRENT_ACTION_SIGNAL":JSON.stringify(J),"import.meta.env.VITE_SELECTED_PROPERTY":JSON.stringify(i),"import.meta.env.VITE_HAS_LOCAL_UI_SOURCE":JSON.stringify(I)},logLevel:"info",customLogger:{info(v){U.current(b=>[...b,v].slice(-D))},warn(v){console.warn(`[warn] ${v}`),U.current(b=>[...b,`[warn] ${v}`].slice(-D))},error(v){console.error(`[error] ${v}`),U.current(b=>[...b,`[error] ${v}`].slice(-D))},clearScreen(){},hasWarned:!1,warnOnce(v){},hasErrorLogged:()=>!1}});await E.listen();let z=`http://localhost:${E.config.server?.port||5173}`;oe(z),ie(`Dev server running at ${z}`);let q=()=>{E.close()};process.on("SIGINT",q),process.on("SIGTERM",q),E.watcher.on("change",v=>{}),c("dev-server-running"),process.stdin.resume()}catch{c("error")}},Y=async a=>{if(w==="elements"){let t=L.find(i=>i.value===a.value);if(!t)return;Q(t),c("loading-actions-signals");try{let i=await S.loadElementPointers(t.path,"auto"),l=[];i.actions&&Array.isArray(i.actions)&&i.actions.forEach((s,n)=>{l.push({label:`Action: ${s.name||s.key}`,value:s.key,type:"action",path:t.path,description:s.description})}),i.signals&&Array.isArray(i.signals)&&i.signals.forEach((s,n)=>{l.push({label:`Signal: ${s.name||s.key}`,value:s.key,type:"signal",path:t.path,description:s.description})}),l.length===0&&l.push({label:"Default Component",value:"default",type:"action",path:t.path,description:"Default component from element"}),Z(l),G("actions-signals"),c("ready")}catch{c("error")}}else if(w==="actions-signals"){let t=k.find(i=>i.value===a.value);if(!t||!T)return;ee(t),c("loading-properties");try{let i=await S.loadElementPointers(T.path,"auto"),l=i.actions?.find(n=>n.key===t.value)||i.signals?.find(n=>n.key===t.value);if(l&&l.ui){R(t.value),c("launching"),M(T,t,null).catch(n=>{c("error")});return}if(!l||!l.props){R(t.value),c("launching");try{await M(T,t,null)}catch{c("error")}return}let s=[];if(l.props.forEach(n=>{n.ui&&s.push({label:`\u{1F3A8} ${n.key} (${n.ui})`,value:`ui-${n.key}`,propertyKey:n.key,type:"ui-variant",uiPath:n.ui,description:n.description,propertyData:n})}),s.length===0){R(t.value),c("launching"),await M(T,t,null);return}te(s),G("properties"),c("ready")}catch{c("error")}}else{let t=B.find(i=>i.value===a.value);if(!t||!A||!T)return;re(t),R(t.value),c("launching"),await M(T,A,t)}};return x==="loading"?r(m,{flexDirection:"column",marginTop:2,children:[r(e,{children:["\u{1F50D} Loading elements from: ",o(e,{color:"cyan",children:f})]}),o(e,{children:"Loading..."})]}):x==="no-elements"?r(m,{flexDirection:"column",marginTop:2,children:[r(e,{color:"red",children:["\u274C No valid elements found in: ",o(e,{color:"cyan",children:f})]}),o(e,{color:"yellow",children:"Make sure the directory contains valid element modules."}),o(e,{color:"yellow",children:"Supported formats: Pipedream, n8n, Doflo, Process.co"}),o(e,{color:"yellow",children:"Supported file types: .js, .ts, .mjs, .mts, .jsx, .tsx"})]}):x==="error"?r(m,{flexDirection:"column",marginTop:2,children:[r(e,{color:"red",children:["\u274C Error loading elements from: ",o(e,{color:"cyan",children:f})]}),o(e,{color:"yellow",children:"Check that the directory contains valid element modules."})]}):x==="loading-actions-signals"?r(m,{flexDirection:"column",marginTop:2,children:[r(e,{children:["\u{1F50D} Loading actions and signals for '",o(e,{color:"cyan",children:T?.info.name}),"'..."]}),o(e,{children:"Loading..."})]}):x==="loading-properties"?r(m,{flexDirection:"column",marginTop:2,children:[r(e,{children:["\u{1F50D} Loading properties for '",o(e,{color:"cyan",children:A?.label}),"'..."]}),o(e,{children:"Loading..."})]}):x==="launching"?r(m,{flexDirection:"column",marginTop:2,children:[r(e,{color:"green",children:["\u{1F680} Launching dev server for '",o(e,{color:"cyan",children:ne}),"'..."]}),r(e,{children:["Directory: ",o(e,{color:"cyan",children:f})]})]}):x==="dev-server-running"?r(ge,{children:[r(m,{flexDirection:"column",flexShrink:1,borderStyle:"round",margin:2,marginBottom:1,paddingX:2,paddingY:1,borderColor:"#8759F2",children:[r(e,{children:["Server Running: ",o(e,{color:"#01D4E7",underline:!0,children:$})]}),r(e,{children:["Element: ",o(e,{color:"#01D4E7",children:T?.info.name})]}),r(e,{children:["Action/Signal: ",o(e,{color:"#01D4E7",children:A?.label})]}),K?r(e,{children:["Property UI: ",o(e,{color:"#01D4E7",children:K.label})]}):r(e,{children:["UI Mode: ",o(e,{color:"#01D4E7",children:"Action/Signal Level"})]}),se&&r(e,{children:["UI Source: ",o(e,{color:"#8759F2",children:"Local Monorepo (Hot Reload Enabled)"})]}),o(e,{color:"yellow",children:"Press Ctrl+C to stop the server"})]}),r(m,{marginTop:1,marginLeft:4,flexDirection:"column",children:[o(e,{color:"gray",children:"Server Status:"}),C.length>0?C.map((a,t)=>o(e,{color:"gray",children:a},t)):o(e,{color:"gray",children:"Waiting for activity..."})]})]}):w==="properties"?r(m,{flexDirection:"column",children:[r(e,{children:["\u{1F4C1} Element: ",o(e,{color:"cyan",children:T?.info.name})]}),r(e,{children:["\u{1F4CB} Action/Signal: ",o(e,{color:"#01D4E7",children:A?.label})]}),r(e,{children:["Found ",B.length," property(ies):"]}),o(W,{items:B,onSelect:Y})]}):w==="actions-signals"?r(m,{flexDirection:"column",marginTop:2,marginBottom:2,children:[r(e,{children:["\u{1F4C1} Element: ",o(e,{color:"#01D4E7",children:T?.info.name})]}),r(m,{flexDirection:"column",marginTop:1,children:[r(e,{children:["Found ",k.length," action(s)/signal(s):"]}),o(W,{items:k,onSelect:Y})]})]}):r(m,{flexDirection:"column",marginTop:2,marginBottom:2,children:[r(m,{flexDirection:"column",children:[r(e,{children:["\u{1F4C1} Directory: ",o(e,{color:"#01D4E7",children:f})]}),r(m,{flexDirection:"column",marginTop:1,children:[r(e,{children:["Found ",L.length," element(s):"]}),o(W,{items:L,onSelect:Y})]})]}),o(fe,{logs:C})]})},fe=({logs:f})=>f.length?r(m,{flexDirection:"column",marginTop:1,children:[o(e,{color:"gray",children:"Output:"}),f.map((L,V)=>o(e,{color:"gray",children:L},V))]}):null;export{Pe as a};
