import{useState as y,useEffect as H,useRef as ce}from"react";import{Box as m,Text as e}from"ink";import W from"ink-select-input";import T from"fs";import u from"path";import{createServer as ue}from"vite";import{fileURLToPath as me}from"url";import S from"@process.co/element-dev-support/dist/index.js";import{Fragment as fe,jsx as r,jsxs as o}from"react/jsx-runtime";var Pe=({rootDir:g})=>{let[L,w]=y([]),[E,Q]=y(null),[C,Z]=y([]),[A,ee]=y(null),[j,te]=y([]),[ne,U]=y(null),[K,oe]=y(null),[x,c]=y("loading"),[V,G]=y("elements"),[B,X]=y([]),R=ce(X);R.current=X;let[$,re]=y(null),[pe,ie]=y(null),[se,le]=y(!1),ae=async(a,t,i)=>{try{let l=T.statSync(a).isDirectory()?a:u.dirname(a),s=i==="action"?"actions":"sources",n=u.join(l,s);if(!T.existsSync(n))return null;let p=(await S.importFolderModulesOfType(s,i,l,["common"])).find(d=>d.key===t);if(!p)return null;let P=T.readdirSync(n).filter(d=>{let I=u.join(n,d);return T.statSync(I).isDirectory()}),_=null,M=null;for(let d of P){let I=u.join(n,d),J=[`${d}.mjs`,`${d}.mts`,`${d}.js`,`${d}.ts`,"index.mjs","index.mts","index.js","index.ts"];for(let F of J){let h=u.join(I,F);if(T.existsSync(h))try{let{module:D}=await S.importFromPath(h);if(D.key===t){_=h,M=I;break}}catch{continue}}if(_)break}if(!_)return null;let N=u.join(l,"ui");return p&&p.ui&&(N=u.join(l,"ui",p.ui)),{modulePath:_,uiDir:N}}catch{return null}};H(()=>{(async()=>{try{try{let s=await S.autoDetectElement(g);if(s!=="pipedream"){let n=await S.loadElementPointers(g,s);w([{label:`${n.name} (${n.elementType})`,value:n.name,info:n,path:g}]),c("ready");return}}catch{}let t=T.readdirSync(g,{withFileTypes:!0}),i=[];for(let s of t){let n=u.join(g,s.name);if(s.isDirectory())try{T.readdirSync(n).some(p=>p.endsWith(".mjs")||p.endsWith(".mts")||p.endsWith(".js")||p.endsWith(".ts")||p.endsWith(".tsx")||p.endsWith(".jsx"))&&i.push(n)}catch{}}if(i.length===0){c("no-elements");return}let l=[];for(let s of i)try{let n=await S.loadElementPointers(s,"auto");l.push({label:`${n.name} (${n.elementType})`,value:n.name,info:n,path:s})}catch{}if(l.length>0){w(l),c("ready");return}else c("no-elements")}catch{c("error")}})()},[g]),H(()=>{$&&x==="launching"&&c("dev-server-running")},[$,x]),H(()=>{},[x]);let k=async(a,t,i)=>{if(!a)return;let l=await ae(a.path,t.value,t.type);if(!l){c("error");return}let s=T.statSync(a.path).isDirectory()?a.path:u.dirname(a.path),n=u.join(s,"dev"),O=T.existsSync(n)?n:s,p=me(import.meta.url),P=u.dirname(p),_=u.resolve(P,"../.process/vite.config.cjs"),M=u.join(O,"vite.config.js"),N=u.join(O,"vite.config.ts"),d=_;T.existsSync(M)?d=M:T.existsSync(N)&&(d=N);let I=await S.loadElementPointers(a.path,"auto"),J=I.actions?.find(f=>f.key===t.value)||I.signals?.find(f=>f.key===t.value),F=[u.resolve(process.cwd(),"process-co","ui","src"),u.resolve(P,"..","..","ui","src"),u.resolve(P,"..","ui","src")];console.log("\u{1F50D} Checking for local UI source..."),console.log("   process.cwd():",process.cwd()),console.log("   __dirname:",P);let h=!1;for(let f of F)if(console.log("   Checking path:",f,"exists:",T.existsSync(f)),T.existsSync(f)){h=!0,console.log("   \u2705 Found local UI source at:",f);break}console.log("   hasLocalUISource:",h),le(h),process.env.VITE_ELEMENT_PATH=a.path,process.env.VITE_ELEMENT_TYPE=t.type,process.env.VITE_ELEMENT_NAME=a.info.name,process.env.VITE_ACTION_SIGNAL_KEY=t.value,process.env.VITE_PROPERTY_KEY=i?.propertyKey||"",process.env.VITE_PROPERTY_TYPE=i?.type||"",process.env.VITE_PROPERTY_UI_PATH=i?.uiPath||"",process.env.VITE_MODULE_PATH=l.modulePath,process.env.VITE_UI_DIRECTORY=l.uiDir,process.env.VITE_HAS_LOCAL_UI_SOURCE=h?"true":"false";let D=1;try{let f=await ue({configFile:d,root:u.resolve(P,"../.process"),optimizeDeps:{include:["react","react-dom"],exclude:[a.path]},define:{"import.meta.env.VITE_ELEMENT_PATH":JSON.stringify(a.path),"import.meta.env.VITE_ELEMENT_TYPE":JSON.stringify(t.type),"import.meta.env.VITE_ELEMENT_NAME":JSON.stringify(a.info.name),"import.meta.env.VITE_ACTION_SIGNAL_KEY":JSON.stringify(t.value),"import.meta.env.VITE_PROPERTY_KEY":JSON.stringify(i?.propertyKey||null),"import.meta.env.VITE_PROPERTY_TYPE":JSON.stringify(i?.type||null),"import.meta.env.VITE_PROPERTY_UI_PATH":JSON.stringify(i?.uiPath||null),"import.meta.env.VITE_MODULE_PATH":JSON.stringify(l.modulePath),"import.meta.env.VITE_UI_DIRECTORY":JSON.stringify(l.uiDir),"import.meta.env.VITE_ELEMENT_MODULE":JSON.stringify(I),"import.meta.env.VITE_CURRENT_ACTION_SIGNAL":JSON.stringify(J),"import.meta.env.VITE_SELECTED_PROPERTY":JSON.stringify(i),"import.meta.env.VITE_HAS_LOCAL_UI_SOURCE":JSON.stringify(h)},logLevel:"info",customLogger:{info(v){R.current(b=>[...b,v].slice(-D))},warn(v){console.warn(`[warn] ${v}`),R.current(b=>[...b,`[warn] ${v}`].slice(-D))},error(v){console.error(`[error] ${v}`),R.current(b=>[...b,`[error] ${v}`].slice(-D))},clearScreen(){},hasWarned:!1,warnOnce(v){},hasErrorLogged:()=>!1}});await f.listen();let z=`http://localhost:${f.config.server?.port||5173}`;re(z),ie(`Dev server running at ${z}`);let q=()=>{f.close()};process.on("SIGINT",q),process.on("SIGTERM",q),f.watcher.on("change",v=>{}),c("dev-server-running"),process.stdin.resume()}catch{c("error")}},Y=async a=>{if(V==="elements"){let t=L.find(i=>i.value===a.value);if(!t)return;Q(t),c("loading-actions-signals");try{let i=await S.loadElementPointers(t.path,"auto"),l=[];i.actions&&Array.isArray(i.actions)&&i.actions.forEach((s,n)=>{l.push({label:`Action: ${s.name||s.key}`,value:s.key,type:"action",path:t.path,description:s.description})}),i.signals&&Array.isArray(i.signals)&&i.signals.forEach((s,n)=>{l.push({label:`Signal: ${s.name||s.key}`,value:s.key,type:"signal",path:t.path,description:s.description})}),l.length===0&&l.push({label:"Default Component",value:"default",type:"action",path:t.path,description:"Default component from element"}),Z(l),G("actions-signals"),c("ready")}catch{c("error")}}else if(V==="actions-signals"){let t=C.find(i=>i.value===a.value);if(!t||!E)return;ee(t),c("loading-properties");try{let i=await S.loadElementPointers(E.path,"auto"),l=i.actions?.find(n=>n.key===t.value)||i.signals?.find(n=>n.key===t.value);if(l&&l.ui){U(t.value),c("launching"),k(E,t,null).catch(n=>{c("error")});return}if(!l||!l.props){U(t.value),c("launching");try{await k(E,t,null)}catch{c("error")}return}let s=[];if(l.props.forEach(n=>{n.ui&&s.push({label:`\u{1F3A8} ${n.key} (${n.ui})`,value:`ui-${n.key}`,propertyKey:n.key,type:"ui-variant",uiPath:n.ui,description:n.description,propertyData:n})}),s.length===0){U(t.value),c("launching"),await k(E,t,null);return}te(s),G("properties"),c("ready")}catch{c("error")}}else{let t=j.find(i=>i.value===a.value);if(!t||!A||!E)return;oe(t),U(t.value),c("launching"),await k(E,A,t)}};return x==="loading"?o(m,{flexDirection:"column",marginTop:2,children:[o(e,{children:["\u{1F50D} Loading elements from: ",r(e,{color:"cyan",children:g})]}),r(e,{children:"Loading..."})]}):x==="no-elements"?o(m,{flexDirection:"column",marginTop:2,children:[o(e,{color:"red",children:["\u274C No valid elements found in: ",r(e,{color:"cyan",children:g})]}),r(e,{color:"yellow",children:"Make sure the directory contains valid element modules."}),r(e,{color:"yellow",children:"Supported formats: Pipedream, n8n, Doflo, Process.co"}),r(e,{color:"yellow",children:"Supported file types: .js, .ts, .mjs, .mts, .jsx, .tsx"})]}):x==="error"?o(m,{flexDirection:"column",marginTop:2,children:[o(e,{color:"red",children:["\u274C Error loading elements from: ",r(e,{color:"cyan",children:g})]}),r(e,{color:"yellow",children:"Check that the directory contains valid element modules."})]}):x==="loading-actions-signals"?o(m,{flexDirection:"column",marginTop:2,children:[o(e,{children:["\u{1F50D} Loading actions and signals for '",r(e,{color:"cyan",children:E?.info.name}),"'..."]}),r(e,{children:"Loading..."})]}):x==="loading-properties"?o(m,{flexDirection:"column",marginTop:2,children:[o(e,{children:["\u{1F50D} Loading properties for '",r(e,{color:"cyan",children:A?.label}),"'..."]}),r(e,{children:"Loading..."})]}):x==="launching"?o(m,{flexDirection:"column",marginTop:2,children:[o(e,{color:"green",children:["\u{1F680} Launching dev server for '",r(e,{color:"cyan",children:ne}),"'..."]}),o(e,{children:["Directory: ",r(e,{color:"cyan",children:g})]})]}):x==="dev-server-running"?o(fe,{children:[o(m,{flexDirection:"column",flexShrink:1,borderStyle:"round",margin:2,marginBottom:1,paddingX:2,paddingY:1,borderColor:"#8759F2",children:[o(e,{children:["Server Running: ",r(e,{color:"#01D4E7",underline:!0,children:$})]}),o(e,{children:["Element: ",r(e,{color:"#01D4E7",children:E?.info.name})]}),o(e,{children:["Action/Signal: ",r(e,{color:"#01D4E7",children:A?.label})]}),K?o(e,{children:["Property UI: ",r(e,{color:"#01D4E7",children:K.label})]}):o(e,{children:["UI Mode: ",r(e,{color:"#01D4E7",children:"Action/Signal Level"})]}),se&&o(e,{children:["UI Source: ",r(e,{color:"#8759F2",children:"Local Monorepo (Hot Reload Enabled)"})]}),r(e,{color:"yellow",children:"Press Ctrl+C to stop the server"})]}),o(m,{marginTop:1,marginLeft:4,flexDirection:"column",children:[r(e,{color:"gray",children:"Server Status:"}),B.length>0?B.map((a,t)=>r(e,{color:"gray",children:a},t)):r(e,{color:"gray",children:"Waiting for activity..."})]})]}):V==="properties"?o(m,{flexDirection:"column",children:[o(e,{children:["\u{1F4C1} Element: ",r(e,{color:"cyan",children:E?.info.name})]}),o(e,{children:["\u{1F4CB} Action/Signal: ",r(e,{color:"#01D4E7",children:A?.label})]}),o(e,{children:["Found ",j.length," property(ies):"]}),r(W,{items:j,onSelect:Y})]}):V==="actions-signals"?o(m,{flexDirection:"column",marginTop:2,marginBottom:2,children:[o(e,{children:["\u{1F4C1} Element: ",r(e,{color:"#01D4E7",children:E?.info.name})]}),o(m,{flexDirection:"column",marginTop:1,children:[o(e,{children:["Found ",C.length," action(s)/signal(s):"]}),r(W,{items:C,onSelect:Y})]})]}):o(m,{flexDirection:"column",marginTop:2,marginBottom:2,children:[o(m,{flexDirection:"column",children:[o(e,{children:["\u{1F4C1} Directory: ",r(e,{color:"#01D4E7",children:g})]}),o(m,{flexDirection:"column",marginTop:1,children:[o(e,{children:["Found ",L.length," element(s):"]}),r(W,{items:L,onSelect:Y})]})]}),r(ge,{logs:B})]})},ge=({logs:g})=>g.length?o(m,{flexDirection:"column",marginTop:1,children:[r(e,{color:"gray",children:"Output:"}),g.map((L,w)=>r(e,{color:"gray",children:L},w))]}):null;export{Pe as a};
