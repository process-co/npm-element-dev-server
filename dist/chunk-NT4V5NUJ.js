import{useState as y,useEffect as F,useRef as ie}from"react";import{Box as m,Text as e}from"ink";import W from"ink-select-input";import E from"fs";import u from"path";import{createServer as se}from"vite";import{fileURLToPath as le}from"url";import v from"@process.co/element-dev-support/dist/index.js";import{Fragment as ce,jsx as o,jsxs as r}from"react/jsx-runtime";var he=({rootDir:g})=>{let[P,V]=y([]),[T,z]=y(null),[k,q]=y([]),[_,Q]=y(null),[Y,Z]=y([]),[ee,b]=y(null),[K,te]=y(null),[x,c]=y("loading"),[R,H]=y("elements"),[C,G]=y([]),w=ie(G);w.current=G;let[U,ne]=y(null),[ue,re]=y(null),oe=async(a,t,i)=>{try{let l=E.statSync(a).isDirectory()?a:u.dirname(a),s=i==="action"?"actions":"sources",n=u.join(l,s);if(!E.existsSync(n))return null;let f=(await v.importFolderModulesOfType(s,i,l,["common"])).find(p=>p.key===t);if(!f)return null;let j=E.readdirSync(n).filter(p=>{let h=u.join(n,p);return E.statSync(h).isDirectory()}),S=null,B=null;for(let p of j){let h=u.join(n,p),J=[`${p}.mjs`,`${p}.mts`,`${p}.js`,`${p}.ts`,"index.mjs","index.mts","index.js","index.ts"];for(let L of J){let d=u.join(h,L);if(E.existsSync(d))try{let{module:N}=await v.importFromPath(d);if(N.key===t){S=d,B=h;break}}catch{continue}}if(S)break}if(!S)return null;let A=u.join(l,"ui");return f&&f.ui&&(A=u.join(l,"ui",f.ui)),{modulePath:S,uiDir:A}}catch{return null}};F(()=>{(async()=>{try{try{let s=await v.autoDetectElement(g);if(s!=="pipedream"){let n=await v.loadElementPointers(g,s);V([{label:`${n.name} (${n.elementType})`,value:n.name,info:n,path:g}]),c("ready");return}}catch{}let t=E.readdirSync(g,{withFileTypes:!0}),i=[];for(let s of t){let n=u.join(g,s.name);if(s.isDirectory())try{E.readdirSync(n).some(f=>f.endsWith(".mjs")||f.endsWith(".mts")||f.endsWith(".js")||f.endsWith(".ts")||f.endsWith(".tsx")||f.endsWith(".jsx"))&&i.push(n)}catch{}}if(i.length===0){c("no-elements");return}let l=[];for(let s of i)try{let n=await v.loadElementPointers(s,"auto");l.push({label:`${n.name} (${n.elementType})`,value:n.name,info:n,path:s})}catch{}if(l.length>0){V(l),c("ready");return}else c("no-elements")}catch{c("error")}})()},[g]),F(()=>{U&&x==="launching"&&c("dev-server-running")},[U,x]),F(()=>{},[x]);let M=async(a,t,i)=>{if(!a)return;let l=await oe(a.path,t.value,t.type);if(!l){c("error");return}let s=E.statSync(a.path).isDirectory()?a.path:u.dirname(a.path),n=u.join(s,"dev"),D=E.existsSync(n)?n:s,f=le(import.meta.url),j=u.dirname(f),S=u.resolve(j,"../.process/vite.config.cjs"),B=u.join(D,"vite.config.js"),A=u.join(D,"vite.config.ts"),p=S;E.existsSync(B)?p=B:E.existsSync(A)&&(p=A);let h=await v.loadElementPointers(a.path,"auto"),J=h.actions?.find(d=>d.key===t.value)||h.signals?.find(d=>d.key===t.value);process.env.VITE_ELEMENT_PATH=a.path,process.env.VITE_ELEMENT_TYPE=t.type,process.env.VITE_ELEMENT_NAME=a.info.name,process.env.VITE_ACTION_SIGNAL_KEY=t.value,process.env.VITE_PROPERTY_KEY=i?.propertyKey||"",process.env.VITE_PROPERTY_TYPE=i?.type||"",process.env.VITE_PROPERTY_UI_PATH=i?.uiPath||"",process.env.VITE_MODULE_PATH=l.modulePath,process.env.VITE_UI_DIRECTORY=l.uiDir;let L=1;try{let d=await se({configFile:p,root:u.resolve(j,"../.process"),optimizeDeps:{include:["react","react-dom"],exclude:[a.path]},define:{"import.meta.env.VITE_ELEMENT_PATH":JSON.stringify(a.path),"import.meta.env.VITE_ELEMENT_TYPE":JSON.stringify(t.type),"import.meta.env.VITE_ELEMENT_NAME":JSON.stringify(a.info.name),"import.meta.env.VITE_ACTION_SIGNAL_KEY":JSON.stringify(t.value),"import.meta.env.VITE_PROPERTY_KEY":JSON.stringify(i?.propertyKey||null),"import.meta.env.VITE_PROPERTY_TYPE":JSON.stringify(i?.type||null),"import.meta.env.VITE_PROPERTY_UI_PATH":JSON.stringify(i?.uiPath||null),"import.meta.env.VITE_MODULE_PATH":JSON.stringify(l.modulePath),"import.meta.env.VITE_UI_DIRECTORY":JSON.stringify(l.uiDir),"import.meta.env.VITE_ELEMENT_MODULE":JSON.stringify(h),"import.meta.env.VITE_CURRENT_ACTION_SIGNAL":JSON.stringify(J),"import.meta.env.VITE_SELECTED_PROPERTY":JSON.stringify(i)},logLevel:"info",customLogger:{info(I){w.current(O=>[...O,I].slice(-L))},warn(I){w.current(O=>[...O,`[warn] ${I}`].slice(-L))},error(I){w.current(O=>[...O,`[error] ${I}`].slice(-L))},clearScreen(){},hasWarned:!1,warnOnce(I){},hasErrorLogged:()=>!1}});await d.listen();let N=`http://localhost:${d.config.server?.port||5173}`;ne(N),re(`Dev server running at ${N}`);let X=()=>{d.close()};process.on("SIGINT",X),process.on("SIGTERM",X),d.watcher.on("change",I=>{}),c("dev-server-running"),process.stdin.resume()}catch{c("error")}},$=async a=>{if(R==="elements"){let t=P.find(i=>i.value===a.value);if(!t)return;z(t),c("loading-actions-signals");try{let i=await v.loadElementPointers(t.path,"auto"),l=[];i.actions&&Array.isArray(i.actions)&&i.actions.forEach((s,n)=>{l.push({label:`Action: ${s.name||s.key}`,value:s.key,type:"action",path:t.path,description:s.description})}),i.signals&&Array.isArray(i.signals)&&i.signals.forEach((s,n)=>{l.push({label:`Signal: ${s.name||s.key}`,value:s.key,type:"signal",path:t.path,description:s.description})}),l.length===0&&l.push({label:"Default Component",value:"default",type:"action",path:t.path,description:"Default component from element"}),q(l),H("actions-signals"),c("ready")}catch{c("error")}}else if(R==="actions-signals"){let t=k.find(i=>i.value===a.value);if(!t||!T)return;Q(t),c("loading-properties");try{let i=await v.loadElementPointers(T.path,"auto"),l=i.actions?.find(n=>n.key===t.value)||i.signals?.find(n=>n.key===t.value);if(l&&l.ui){b(t.value),c("launching"),M(T,t,null).catch(n=>{c("error")});return}if(!l||!l.props){b(t.value),c("launching");try{await M(T,t,null)}catch{c("error")}return}let s=[];if(l.props.forEach(n=>{n.ui&&s.push({label:`\u{1F3A8} ${n.key} (${n.ui})`,value:`ui-${n.key}`,propertyKey:n.key,type:"ui-variant",uiPath:n.ui,description:n.description,propertyData:n})}),s.length===0){b(t.value),c("launching"),await M(T,t,null);return}Z(s),H("properties"),c("ready")}catch{c("error")}}else{let t=Y.find(i=>i.value===a.value);if(!t||!_||!T)return;te(t),b(t.value),c("launching"),await M(T,_,t)}};return x==="loading"?r(m,{flexDirection:"column",marginTop:2,children:[r(e,{children:["\u{1F50D} Loading elements from: ",o(e,{color:"cyan",children:g})]}),o(e,{children:"Loading..."})]}):x==="no-elements"?r(m,{flexDirection:"column",marginTop:2,children:[r(e,{color:"red",children:["\u274C No valid elements found in: ",o(e,{color:"cyan",children:g})]}),o(e,{color:"yellow",children:"Make sure the directory contains valid element modules."}),o(e,{color:"yellow",children:"Supported formats: Pipedream, n8n, Doflo, Process.co"}),o(e,{color:"yellow",children:"Supported file types: .js, .ts, .mjs, .mts, .jsx, .tsx"})]}):x==="error"?r(m,{flexDirection:"column",marginTop:2,children:[r(e,{color:"red",children:["\u274C Error loading elements from: ",o(e,{color:"cyan",children:g})]}),o(e,{color:"yellow",children:"Check that the directory contains valid element modules."})]}):x==="loading-actions-signals"?r(m,{flexDirection:"column",marginTop:2,children:[r(e,{children:["\u{1F50D} Loading actions and signals for '",o(e,{color:"cyan",children:T?.info.name}),"'..."]}),o(e,{children:"Loading..."})]}):x==="loading-properties"?r(m,{flexDirection:"column",marginTop:2,children:[r(e,{children:["\u{1F50D} Loading properties for '",o(e,{color:"cyan",children:_?.label}),"'..."]}),o(e,{children:"Loading..."})]}):x==="launching"?r(m,{flexDirection:"column",marginTop:2,children:[r(e,{color:"green",children:["\u{1F680} Launching dev server for '",o(e,{color:"cyan",children:ee}),"'..."]}),r(e,{children:["Directory: ",o(e,{color:"cyan",children:g})]})]}):x==="dev-server-running"?r(ce,{children:[r(m,{flexDirection:"column",flexShrink:1,borderStyle:"round",margin:2,marginBottom:1,paddingX:2,paddingY:1,borderColor:"#8759F2",children:[r(e,{children:["Server Running: ",o(e,{color:"#01D4E7",underline:!0,children:U})]}),r(e,{children:["Element: ",o(e,{color:"#01D4E7",children:T?.info.name})]}),r(e,{children:["Action/Signal: ",o(e,{color:"#01D4E7",children:_?.label})]}),K?r(e,{children:["Property UI: ",o(e,{color:"#01D4E7",children:K.label})]}):r(e,{children:["UI Mode: ",o(e,{color:"#01D4E7",children:"Action/Signal Level"})]}),o(e,{color:"yellow",children:"Press Ctrl+C to stop the server"})]}),r(m,{marginTop:1,marginLeft:4,flexDirection:"column",children:[o(e,{color:"gray",children:"Server Status:"}),C.length>0?C.map((a,t)=>o(e,{color:"gray",children:a},t)):o(e,{color:"gray",children:"Waiting for activity..."})]})]}):R==="properties"?r(m,{flexDirection:"column",children:[r(e,{children:["\u{1F4C1} Element: ",o(e,{color:"cyan",children:T?.info.name})]}),r(e,{children:["\u{1F4CB} Action/Signal: ",o(e,{color:"#01D4E7",children:_?.label})]}),r(e,{children:["Found ",Y.length," property(ies):"]}),o(W,{items:Y,onSelect:$})]}):R==="actions-signals"?r(m,{flexDirection:"column",marginTop:2,marginBottom:2,children:[r(e,{children:["\u{1F4C1} Element: ",o(e,{color:"#01D4E7",children:T?.info.name})]}),r(m,{flexDirection:"column",marginTop:1,children:[r(e,{children:["Found ",k.length," action(s)/signal(s):"]}),o(W,{items:k,onSelect:$})]})]}):r(m,{flexDirection:"column",marginTop:2,marginBottom:2,children:[r(m,{flexDirection:"column",children:[r(e,{children:["\u{1F4C1} Directory: ",o(e,{color:"#01D4E7",children:g})]}),r(m,{flexDirection:"column",marginTop:1,children:[r(e,{children:["Found ",P.length," element(s):"]}),o(W,{items:P,onSelect:$})]})]}),o(ae,{logs:C})]})},ae=({logs:g})=>g.length?r(m,{flexDirection:"column",marginTop:1,children:[o(e,{color:"gray",children:"Output:"}),g.map((P,V)=>o(e,{color:"gray",children:P},V))]}):null;export{he as a};
